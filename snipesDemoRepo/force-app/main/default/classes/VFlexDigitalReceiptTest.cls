@isTest
public class VFlexDigitalReceiptTest {
    public static final String TEST_RECORD = '{"id":"01FEC2SFKSXF3X0VYFPSXNSAGE","brandId":"SNIPES-01-062920","webhookId":"9063ec5c-864a-4b52-87c2-65ad875a9195","attemptId":"01FEC2SFRH3JAAR0RR7QNKDZEB","created":"2021-08-30T17:47:54.361704Z","type":"RECEIPTS","data":{"accessibility":false,"apiRequest":{"apiVersion":"SOAPV4","data":{"customerEmailAddress":"ronald.veluya@snipesusa.com","customerTelephone":null,"receipt":{"mode":"Production","receiptHeader":null,"receiptRevision":{"revisionNumber":"1","revisionDateTime":"2021-08-30T13:45:26-04:00"},"receiptType":"DIGITAL_AND_PAPER","receiptBarcodeType":"CODE_128","receiptBarcodeNumber":"978401001287083021","receiptDateTime":"2021-08-30T13:45:26-04:00","transactionLoyalty":null,"transactionType":"ReturnTransaction","relatedTransactionReference":null,"transactionNumber":"1287","transactionItem":[],"transactionReturn":[{"originalStoreNumber":"9784","originalRegister":"1","originalTransactionNumber":"1286","item":[{"itemName":"AUTHENTIC CATS","itemDescription":{"value":"1000017015          |No Color|10               "},"itemClassCode":null,"itemSKUNumber":"10008500030","itemUPCNumber":null,"itemSerialNumber":null,"itemModelNumber":null,"itemBrand":null,"itemIndustry":null,"itemManufacturer":null,"itemPrice":{"value":-55,"currency":"USD","foreignAmount":null},"itemTotal":{"value":-55,"currency":"USD","foreignAmount":null},"itemPriceNotation":"TX","itemQuantity":{"value":1,"units":1,"unitOfMeasureCode":"UNIT"},"itemDiscount":[],"itemMisc":{"value":"Reason: Wrong Size"},"itemCategory":null,"itemCustomCategory1":null,"itemCustomCategory2":null,"itemGiftCard":null,"item":[]}],"miscText":null}],"transactionOrder":[],"transactionGrossAmount":{"value":-55,"currency":"USD","foreignAmount":null},"transactionDiscount":[],"transactionNetAmount":{"value":-55,"currency":"USD","foreignAmount":null},"transactionTaxes":[{"taxDescription":"Non Taxable","taxPercent":0,"taxableAmount":{"value":55,"currency":"USD","foreignAmount":null},"taxAmount":{"value":0,"currency":"USD","foreignAmount":null},"taxTypeCode":"SALES"}],"transactionGrandAmount":{"value":-55,"currency":"USD","foreignAmount":null},"transactionTenderApplied":{"value":-55,"currency":"USD","foreignAmount":null},"transactionBalanceDue":null,"transactionChangeDue":null,"transactionTip":null,"transactionServiceCharge":null,"transactionTender":[{"tenderTypeCode":"Cash","tenderDateTime":"2021-08-30T17:47:10.484Z","tenderAmount":{"value":-55,"currency":"USD","foreignAmount":null},"tenderCreditDebit":null,"tenderGiftCard":null,"tenderAuthorizationCode":null,"tenderTypeMisc":null,"tenderSignature":null,"tenderEMV":null}],"transactionTenderHistory":[],"transactionDeposit":null,"transactionSoldTo":null,"transactionFees":[],"transactionDeliveryPickup":null,"transactionSignature":null,"transactionTerms":[],"transactionTrackingPixel":null,"additionalInfo1":null,"additionalInfo2":null,"additionalInfo3":null,"additionalInfo4":null,"additionalInfo5":null,"rawPosReceipt": null},"workstation":{"workstationID":"1","workstationOperator":"9999","workstationAssociate":"9999","workstationStore":{"merchant":{"merchantID":"SNIPES-01-062920"},"storeID":"9784","storeName":"Aptos Lab 2","storeAddress":{"typeCode":"RETAIL_STORE","addressLine1":"400 Venture Drive","addressLine2":null,"addressLine3":null,"city":"Lewis Center","territory":"OH","postalCode":"43035","country":{"value":"United States","code":"US"},"postalCodeExtension":null},"storeTelephone":{"areaCode":null,"localNumber":"5144260822","typeCode":"WORK"}}}}},"approvalRequired":false,"associates":{"associate":{"name":"9999"},"operator":{"name":"9999","operatorType":"Cashier"}},"barcode":{"type":"Code128","number":"978401001287083021"},"cashier":"9999","containsItemWithUnitPrice":false,"contentLocale":"en-US","customerEmailAddress":"RONALD.VELUYA@SNIPESUSA.COM","customerRefId":"8297","customProperties":{"creationRequestDate":1630345673772},"deliveryChannels":["EMAIL"],"discounts":[],"employeeFullName":"9999","fees":[],"id":"1543747a-f7b4-4198-8d9c-fbe98ec1f6a5","items":[],"merchant":{"active":true,"address":{"address1":"101 E. Olney Ave.","address2":"","address3":"","city":"Philadelphia","state":"PA","country":"US","countryCode":"","fullAddress":"101 E. Olney Ave.","postalCode":"19120"},"annualRevenue":0,"annualTransactions":0,"contactName":"Customer Service","id":41,"masterAccountEmailAddress":"CUSTOMER.SERVICE@SNIPESUSA.XX","masterAccountId":6099,"merchantId":"SNIPES-01-062920","name":"SNIPES USA","numOfAnnualCustomers":0,"numOfEmployees":0,"numOfStores":0,"phoneNumber":"8004242854","publiclyTraded":false,"region":" ","yearEstablished":0},"merchantRefId":"41","orders":[],"payments":[{"displayOrder":1,"paymentTypeSummary":"Cash","supportingDocuments":{}}],"paymentType":"Cash","rawReceipt": null,"receiptAmount":{"amount":-55},"receiptDate":1630345526000,"receiptProfileId":210,"receiptProfileName":"DEFAULT-SNIPES-V0.8","receiptTemplateId":408,"receiptTemplateName":"TEMPLATE-SNIPES-V1.2","receiptType":"DIGITAL_PAPER","registerNumber":"1","returns":[{"originalStoreNumber":"9784","originalRegister":"1","originalTransactionNumber":"1286","items":[{"amount":{"amount":-55,"currencyCode":"USD"},"description":{"format":"TABS_NEWLINE","text":"1000017015          |No Color|10               "},"discounts":[],"miscInfo":{"format":"TABS_NEWLINE","text":"Reason: Wrong Size"},"name":"AUTHENTIC CATS","price":{"amount":-55,"currencyCode":"USD"},"priceNotation":"TX","quantity":{"value":1,"units":1,"unitOfMeasureCode":"UNIT"},"sku":"10008500030","subItem":[],"supportingDocuments":{}}]}],"revision":{"date":1630345526000,"number":"1"},"store":{"active":false,"id":"3349","name":"APTOS LAB 2","storeGroupId":82,"storeGroupName":"FLEX TEST GROUP","storeId":"9784"},"storeRefId":"3349","supportingDocuments":{},"taxes":[{"amount":{"amount":0,"currencyCode":"USD"},"customProperties":{},"description":{"format":"NONE","text":"Non Taxable"},"displayOrder":1,"percent":0,"taxableAmount":{"amount":55,"currencyCode":"USD"},"taxTypeCode":"SALES"}],"tender":[{"tenderType":"Cash","amount":{"amount":-55,"currencyCode":"USD"},"supportingDocuments":{},"tenderDate":1630345630484}],"tenderHistory":[],"terms":[],"transactionGrandAmount":{"amount":-55,"currencyCode":"USD"},"transactionGrossAmount":{"amount":-55,"currencyCode":"USD"},"transactionNetAmount":{"amount":-55,"currencyCode":"USD"},"transactionNumber":"1287","transactionTenderApplied":{"amount":-55,"currencyCode":"USD"},"transactionType":"ReturnTransaction","validBarcode":false,"zonedReceiptDate":"2021-08-30T13:45:26-04:00"}}';
    public static final String TEST_RECORD_2 = '{"id":"01FEC2N4NPWHCT4Z1ZSCC4NRM5","brandId":"SNIPES-01-062920","webhookId":"9063ec5c-864a-4b52-87c2-65ad875a9195","attemptId":"01FEC2N5XY98VAGFV10QTYNGE4","created":"2021-08-30T17:45:32.086763Z","type":"RECEIPTS","data":{"accessibility":false,"apiRequest":{"apiVersion":"SOAPV4","data":{"customerEmailAddress":"ronald.veluya@snipesusa.com","customerTelephone":null,"receipt":{"mode":"Production","receiptHeader":null,"receiptRevision":{"revisionNumber":"1","revisionDateTime":"2021-08-30T13:42:42-04:00"},"receiptType":"DIGITAL_AND_PAPER","receiptBarcodeType":"CODE_128","receiptBarcodeNumber":"978401001286083021","receiptDateTime":"2021-08-30T13:42:42-04:00","transactionLoyalty":null,"transactionType":"SaleTransaction","relatedTransactionReference":null,"transactionNumber":"1286","transactionItem":[{"itemName":"AUTHENTIC CATS","itemDescription":{"value":"1000017015          |No Color|10               "},"itemClassCode":null,"itemSKUNumber":"10008500030","itemUPCNumber":null,"itemSerialNumber":null,"itemModelNumber":null,"itemBrand":null,"itemIndustry":null,"itemManufacturer":null,"itemPrice":{"value":55,"currency":"USD","foreignAmount":null},"itemTotal":{"value":55,"currency":"USD","foreignAmount":null},"itemPriceNotation":"TX","itemQuantity":{"value":1,"units":1,"unitOfMeasureCode":"UNIT"},"itemDiscount":[],"itemMisc":null,"itemCategory":null,"itemCustomCategory1":null,"itemCustomCategory2":null,"itemGiftCard":null,"item":[]}],"transactionReturn":[],"transactionOrder":[],"transactionGrossAmount":{"value":55,"currency":"USD","foreignAmount":null},"transactionDiscount":[],"transactionNetAmount":{"value":55,"currency":"USD","foreignAmount":null},"transactionTaxes":[{"taxDescription":"Non Taxable","taxPercent":0,"taxableAmount":{"value":55,"currency":"USD","foreignAmount":null},"taxAmount":{"value":0,"currency":"USD","foreignAmount":null},"taxTypeCode":"SALES"}],"transactionGrandAmount":{"value":55,"currency":"USD","foreignAmount":null},"transactionTenderApplied":{"value":55,"currency":"USD","foreignAmount":null},"transactionBalanceDue":null,"transactionChangeDue":null,"transactionTip":null,"transactionServiceCharge":null,"transactionTender":[{"tenderTypeCode":"Cash","tenderDateTime":"2021-08-30T17:44:58.559Z","tenderAmount":{"value":55,"currency":"USD","foreignAmount":null},"tenderCreditDebit":null,"tenderGiftCard":null,"tenderAuthorizationCode":null,"tenderTypeMisc":null,"tenderSignature":null,"tenderEMV":null}],"transactionTenderHistory":[],"transactionDeposit":null,"transactionSoldTo": { "soldToCustomerName": "Test Name" },"transactionFees":[],"transactionDeliveryPickup":null,"transactionSignature":null,"transactionTerms":[],"transactionTrackingPixel":null,"additionalInfo1":null,"additionalInfo2":null,"additionalInfo3":null,"additionalInfo4":null,"additionalInfo5":null,"rawPosReceipt": null},"workstation":{"workstationID":"1","workstationOperator":"9999","workstationAssociate":"9999","workstationStore":{"merchant":{"merchantID":"SNIPES-01-062920"},"storeID":"9784","storeName":"Aptos Lab 2","storeAddress":{"typeCode":"RETAIL_STORE","addressLine1":"400 Venture Drive","addressLine2":null,"addressLine3":null,"city":"Lewis Center","territory":"OH","postalCode":"43035","country":{"value":"United States","code":"US"},"postalCodeExtension":null},"storeTelephone":{"areaCode":null,"localNumber":"5144260822","typeCode":"WORK"}}}}},"approvalRequired":false,"associates":{"associate":{"name":"9999"},"operator":{"name":"9999","operatorType":"Cashier"}},"barcode":{"type":"Code128","number":"978401001286083021"},"cashier":"9999","containsItemWithUnitPrice":false,"contentLocale":"en-US","customerEmailAddress":"RONALD.VELUYA@SNIPESUSA.COM","customerRefId":"8297","customProperties":{"creationRequestDate":1630345531628},"deliveryChannels":["EMAIL"],"discounts":[],"employeeFullName":"9999","fees":[],"id":"afabc07f-a3a4-4cea-b71d-69b0ba4032b2","items":[{"amount":{"amount":55,"currencyCode":"USD"},"customProperties":{},"description":{"format":"TABS_NEWLINE","text":"1000017015          |No Color|10               "},"discounts":[],"displayOrder":1,"lineNumber":"1","name":"AUTHENTIC CATS","price":{"amount":55,"currencyCode":"USD"},"priceNotation":"TX","quantity":{"value":1,"units":1,"unitOfMeasureCode":"UNIT"},"sku":"10008500030","subItem":[],"supportingDocuments":{}}],"merchant":{"active":true,"address":{"address1":"101 E. Olney Ave.","address2":"","address3":"","city":"Philadelphia","state":"PA","country":"US","countryCode":"","fullAddress":"101 E. Olney Ave.","postalCode":"19120"},"annualRevenue":0,"annualTransactions":0,"contactName":"Customer Service","id":41,"masterAccountEmailAddress":"CUSTOMER.SERVICE@SNIPESUSA.XX","masterAccountId":6099,"merchantId":"SNIPES-01-062920","name":"SNIPES USA","numOfAnnualCustomers":0,"numOfEmployees":0,"numOfStores":0,"phoneNumber":"8004242854","publiclyTraded":false,"region":" ","yearEstablished":0},"merchantRefId":"41","orders":[],"payments":[{"displayOrder":1,"paymentTypeSummary":"Cash","supportingDocuments":{}}],"paymentType":"Cash","rawReceipt": null,"receiptAmount":{"amount":55},"receiptDate":1630345362000,"receiptProfileId":210,"receiptProfileName":"DEFAULT-SNIPES-V0.8","receiptTemplateId":408,"receiptTemplateName":"TEMPLATE-SNIPES-V1.2","receiptType":"DIGITAL_PAPER","registerNumber":"1","returns":[],"revision":{"date":1630345362000,"number":"1"},"store":{"active":false,"id":"3349","name":"APTOS LAB 2","storeGroupId":82,"storeGroupName":"FLEX TEST GROUP","storeId":"9784"},"storeRefId":"3349","supportingDocuments":{},"taxes":[{"amount":{"amount":0,"currencyCode":"USD"},"customProperties":{},"description":{"format":"NONE","text":"Non Taxable"},"displayOrder":1,"percent":0,"taxableAmount":{"amount":55,"currencyCode":"USD"},"taxTypeCode":"SALES"}],"tender":[{"tenderType":"Cash","amount":{"amount":55,"currencyCode":"USD"},"supportingDocuments":{},"tenderDate":1630345498559}],"tenderHistory":[],"terms":[],"transactionGrandAmount":{"amount":55,"currencyCode":"USD"},"transactionGrossAmount":{"amount":55,"currencyCode":"USD"},"transactionNetAmount":{"amount":55,"currencyCode":"USD"},"transactionNumber":"1286","transactionTenderApplied":{"amount":55,"currencyCode":"USD"},"transactionType":"SaleTransaction","validBarcode":false,"zonedReceiptDate":"2021-08-30T13:42:42-04:00"}}';

    @isTest
    static void testReceipt() {
        VFlexDigitalReceipt receipt = (VFlexDigitalReceipt)JSON.deserialize(TEST_RECORD, VFlexDigitalReceipt.class);
            receipt.upsertOrder(new Map<String, PricebookEntry>());

        RestContext.request = new RestRequest();
        RestContext.request.requestBody = Blob.valueOf(TEST_RECORD_2);
        RestContext.response = new RestResponse();

        VFlexReceiptREST.doPost();
    }
}